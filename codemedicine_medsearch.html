
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>codemedicine — Global Medical Knowledge Search (Single File)</title>
<meta name="description" content="Aggregated medical search across Europe PMC, PubMed-like sources, ClinicalTrials.gov, Wikipedia, and openFDA. Client-only single-file web app (serve over HTTPS)." />
<style>
:root{
  --bg:#071022; --card:#0b1630; --muted:#9fb0c8; --accent:#38bdf8; --glass:rgba(255,255,255,0.03);
  --success:#34d399; --danger:#fb7185; --text:#e6f0f8;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,#041021,#071026);color:var(--text)}
.app{max-width:1100px;margin:32px auto;padding:20px}
.header{display:flex;align-items:center;gap:16px}
.logo{width:64;height:64;border-radius:10px;background:linear-gradient(135deg,var(--accent),#7c3aed);display:flex;align-items:center;justify-content:center;font-weight:700}
h1{margin:0;font-size:1.6rem}
.lead{color:var(--muted);margin-top:6px;font-size:0.95rem}
.searchbox{display:flex;gap:8px;margin-top:18px}
.input{flex:1;display:flex;gap:8px}
.input input{flex:1;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)}
.input button{padding:10px 14px;border-radius:10px;border:none;background:var(--accent);color:#042233;font-weight:700}
.options{margin-top:12px;display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.card{background:var(--card);border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 6px 18px rgba(3,7,18,0.6)}
.results{margin-top:18px;display:grid;gap:12px}
.result{padding:14px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.02)}
.result h3{margin:0 0 6px 0;font-size:1.05rem}
.badge{display:inline-block;padding:6px 8px;border-radius:999px;font-weight:700;font-size:0.8rem;color:#042233;background:#ddd;margin-left:8px}
.meta{color:var(--muted);font-size:0.85rem;margin-top:8px}
.controls{display:flex;gap:8px;align-items:center}
.small{font-size:0.85rem;color:var(--muted)}
.footer{margin-top:26px;color:var(--muted);font-size:0.85rem}
.flex{display:flex;gap:8px;align-items:center}
.chk{display:inline-flex;gap:6px;align-items:center}
.select{padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)}
.loader{display:inline-block;width:18px;height:18px;border:3px solid rgba(255,255,255,0.08);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.column{display:flex;flex-direction:column}
.row{display:flex;gap:12px}
.export{background:transparent;border:1px dashed rgba(255,255,255,0.06);padding:8px;border-radius:8px;color:var(--muted)}
.source-filters{display:flex;gap:8px;flex-wrap:wrap}
.pill{padding:6px 10px;border-radius:999px;background:var(--glass);border:1px solid rgba(255,255,255,0.02)}
.note{color:#a8c0d8;font-size:0.9rem}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="logo">CM</div>
    <div>
      <h1>codemedicine — Global Medical Knowledge Search</h1>
      <div class="lead">Client-only single-file app. Aggregates Europe PMC, ClinicalTrials.gov, Wikipedia, and openFDA where possible. Serve over HTTPS (GitHub Pages / static host).</div>
    </div>
  </div>

  <div class="card" style="margin-top:18px">
    <form id="searchForm" class="column">
      <div class="searchbox">
        <div class="input">
          <input id="query" placeholder="Search diseases, genes, drugs, organelles, symptoms, procedures..." autofocus />
          <button type="submit">Search</button>
        </div>
        <div class="controls">
          <div id="loading" style="display:none" class="loader" title="Searching"></div>
        </div>
      </div>

      <div class="options">
        <div class="source-filters">
          <label class="chk"><input type="checkbox" class="source" value="eu" checked /> Europe PMC</label>
          <label class="chk"><input type="checkbox" class="source" value="ct" checked /> ClinicalTrials.gov</label>
          <label class="chk"><input type="checkbox" class="source" value="wiki" checked /> Wikipedia</label>
          <label class="chk"><input type="checkbox" class="source" value="openfda" checked /> openFDA</label>
        </div>

        <div style="margin-left:auto" class="row">
          <select id="pagesize" class="select">
            <option value="5">5 per source</option>
            <option value="10" selected>10 per source</option>
            <option value="20">20 per source</option>
          </select>

          <select id="sort" class="select">
            <option value="priority" selected>Smart priority (articles > trials > drugs > wiki)</option>
            <option value="time">Newest first (if available)</option>
            <option value="source">Group by source</option>
          </select>

          <button id="exportBtn" type="button" class="export">Export CSV</button>
        </div>
      </div>
    </form>
  </div>

  <div id="facets" class="card" style="margin-top:12px">
    <div class="row">
      <div class="pill">Results: <span id="count">0</span></div>
      <div class="pill">Unique sources: <span id="scount">0</span></div>
      <div class="pill" id="latency">Latency: -</div>
      <div class="pill" id="warnings" style="display:none;background:#2b1220;color:var(--danger)"></div>
    </div>
    <div style="margin-top:8px" class="note">Notes: this page queries public APIs from the browser. Some providers may require API keys or block direct browser requests (CORS) — the app will attempt best-effort fallbacks and show warnings if a source is unreachable.</div>
  </div>

  <div id="results" class="results"></div>

  <div class="footer">
    <div><strong>Usage:</strong> paste a medical query and press Search. The app queries multiple public medical datasets and merges results. This is an educational aggregator only — not medical advice.</div>
  </div>
</div>

<script>
/*
  codemedicine — single-file client aggregator
  Sources used (best-effort):
    - Europe PMC RESTful Search
    - ClinicalTrials.gov API (study_fields)
    - Wikipedia Action API (search + summary) with &origin=*
    - openFDA (drug label) public API

  Important: This client app works best when served over HTTP(S). Upload to GitHub Pages or any static host.
*/

/* UTIL */
function el(tag, attrs={}, ...children){
  const e = document.createElement(tag);
  for(const k in attrs) e.setAttribute(k, attrs[k]);
  for(const c of children) { if(typeof c === 'string') e.appendChild(document.createTextNode(c)); else if(c) e.appendChild(c); }
  return e;
}
function q(sel){return document.querySelector(sel)}
function formatDate(d){ return new Date(d).toISOString().split('T')[0]; }
function safeText(s){ return (s||'').replace(/\\s+/g,' ').trim(); }

/* API helpers with timeouts and CORS-safe params */
const TIMEOUT = 15000;

async function fetchWithTimeout(url, opts={}, timeout=TIMEOUT){
  const controller = new AbortController();
  const id = setTimeout(()=>controller.abort(), timeout);
  try{
    const r = await fetch(url, {...opts, signal: controller.signal});
    clearTimeout(id);
    return r;
  }catch(e){
    clearTimeout(id);
    throw e;
  }
}

/* Source fetchers */

async function fetchEuropePMC(q, pageSize=10){
  // Europe PMC search (articles) - returns abstracts and metadata
  // Example: https://www.ebi.ac.uk/europepmc/webservices/rest/search?query=covid&format=json&pageSize=10
  const url = `https://www.ebi.ac.uk/europepmc/webservices/rest/search?query=${encodeURIComponent(q)}&format=json&pageSize=${pageSize}`;
  const r = await fetchWithTimeout(url);
  if(!r.ok) throw new Error('Europe PMC error: ' + r.status);
  const j = await r.json();
  const list = (j.resultList && j.resultList.result) || [];
  return list.map(it=>({
    source:'europepmc',
    id: it.id || it.pmid || it.pmcid || it.doi || null,
    title: it.title,
    summary: it.abstractText || it.firstAuthor || '',
    url: it.fullTextUrlList && it.fullTextUrlList.fullTextUrl && it.fullTextUrlList.fullTextUrl[0] && it.fullTextUrlList.fullTextUrl[0].url || (it.pmid?`https://pubmed.ncbi.nlm.nih.gov/${it.pmid}/`:null),
    date: it.pubYear || null
  }));
}

async function fetchClinicalTrials(q, pageSize=5){
  // ClinicalTrials.gov - study_fields endpoint
  // Example: https://clinicaltrials.gov/api/query/study_fields?expr=diabetes&fields=NCTId,BriefTitle,BriefSummary,Condition&min_rnk=1&max_rnk=5&fmt=json
  const max = pageSize;
  const url = `https://clinicaltrials.gov/api/query/study_fields?expr=${encodeURIComponent(q)}&fields=NCTId,BriefTitle,BriefSummary,Condition,StartDate&min_rnk=1&max_rnk=${max}&fmt=json`;
  const r = await fetchWithTimeout(url);
  if(!r.ok) throw new Error('ClinicalTrials.gov error: ' + r.status);
  const j = await r.json();
  const studies = (j.StudyFieldsResponse && j.StudyFieldsResponse.StudyFields) || [];
  return studies.map(s=>({
    source:'clinicaltrials',
    id: s.NCTId && s.NCTId[0],
    title: s.BriefTitle && s.BriefTitle[0],
    summary: s.BriefSummary && s.BriefSummary[0],
    url: s.NCTId && s.NCTId[0] ? `https://clinicaltrials.gov/study/${s.NCTId[0]}` : null,
    date: s.StartDate && s.StartDate[0]
  }));
}

async function fetchWikipedia(q, pageSize=5){
  // Use MediaWiki search + summary endpoints. Use origin=* for CORS.
  const searchUrl = `https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(q)}&format=json&origin=*&srlimit=${pageSize}`;
  const r = await fetchWithTimeout(searchUrl);
  if(!r.ok) throw new Error('Wikipedia search error: ' + r.status);
  const sj = await r.json();
  const results = (sj.query && sj.query.search) || [];
  // fetch summaries in parallel
  const promises = results.map(async item=>{
    try{
      const title = item.title;
      const sumUrl = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`;
      const rr = await fetchWithTimeout(sumUrl);
      if(!rr.ok) return null;
      const sj2 = await rr.json();
      return {
        source:'wikipedia',
        id: sj2.title,
        title: sj2.title,
        summary: sj2.extract,
        url: sj2.content_urls && sj2.content_urls.desktop && sj2.content_urls.desktop.page
      };
    }catch(e){ return null; }
  });
  const out = (await Promise.all(promises)).filter(Boolean);
  return out;
}

async function fetchOpenFDA(q, pageSize=3){
  // openFDA drug label search (may require API key for heavy use). We use the label endpoint searching indications or purpose.
  const encoded = encodeURIComponent(q);
  const url = `https://api.fda.gov/drug/label.json?search=indications_and_usage:${encoded}&limit=${pageSize}`;
  try{
    const r = await fetchWithTimeout(url);
    if(!r.ok) { // try broader search
      const url2 = `https://api.fda.gov/drug/label.json?search=purpose:${encoded}&limit=${pageSize}`;
      const r2 = await fetchWithTimeout(url2);
      if(!r2.ok) throw new Error('openFDA error ' + r2.status);
      const j2 = await r2.json();
      return (j2.results||[]).map(it=>({
        source:'openfda',
        id: it.set_id,
        title: (it.openfda && (it.openfda.brand_name||it.openfda.generic_name)) ? ((it.openfda.brand_name||[])[0] || (it.openfda.generic_name||[])[0]) : (it.spl_id||'openfda'),
        summary: (it.indications_and_usage && it.indications_and_usage[0]) || (it.purpose && it.purpose[0]) || '',
        url: null
      }));
    }
    const j = await r.json();
    return (j.results||[]).map(it=>({
      source:'openfda',
      id: it.set_id,
      title: (it.openfda && (it.openfda.brand_name||it.openfda.generic_name)) ? ((it.openfda.brand_name||[])[0] || (it.openfda.generic_name||[])[0]) : (it.spl_id||'openfda'),
      summary: (it.indications_and_usage && it.indications_and_usage[0]) || (it.purpose && it.purpose[0]) || '',
      url: null
    }));
  }catch(e){
    throw e;
  }
}

/* Aggregator with timeout, concurrency and priority ranking */
async function aggregate(query, sources, pageSize, sortMode, onProgress){
  const start = performance.now();
  const tasks = [];
  const warnings = [];
  if(sources.includes('eu')) tasks.push(fetchEuropePMC(query, pageSize).catch(e=>{warnings.push('EuropePMC: '+e.message); return []}));
  if(sources.includes('ct')) tasks.push(fetchClinicalTrials(query, Math.min(pageSize,10)).catch(e=>{warnings.push('ClinicalTrials: '+e.message); return []}));
  if(sources.includes('wiki')) tasks.push(fetchWikipedia(query, pageSize).catch(e=>{warnings.push('Wikipedia: '+e.message); return []}));
  if(sources.includes('openfda')) tasks.push(fetchOpenFDA(query, Math.min(pageSize,5)).catch(e=>{warnings.push('openFDA: '+e.message); return []}));

  const resultsArr = await Promise.all(tasks);
  let merged = [].concat(...resultsArr);
  // dedupe by (source,id/title)
  const seen = new Set();
  const dedup = [];
  for(const it of merged){
    const key = `${it.source}::${it.id||it.title}`;
    if(seen.has(key)) continue;
    seen.add(key);
    dedup.push(it);
  }
  // scoring / ranking
  const priority = {'europepmc':0,'clinicaltrials':1,'openfda':2,'wikipedia':3};
  dedup.forEach((it, idx)=> it._score = 100 - idx - (priority[it.source]||5));
  if(sortMode === 'priority'){
    dedup.sort((a,b)=> (a._score||0) - (b._score||0));
  }else if(sortMode === 'time'){
    dedup.sort((a,b)=> (b.date||'') > (a.date||'') ? 1 : -1);
  }else if(sortMode === 'source'){
    dedup.sort((a,b)=> (a.source||'').localeCompare(b.source||''));
  }
  const latency = Math.round(performance.now()-start);
  return {items: dedup, warnings, latency};
}

/* Render helpers */
function renderResults(items){
  const container = q('#results');
  container.innerHTML = '';
  items.forEach(it=>{
    const li = el('div', {class:'result'});
    const h = el('h3');
    const a = el('a', {href: it.url || '#', target:'_blank', rel:'noreferrer'}, it.title || it.id || '(no title)');
    h.appendChild(a);
    const b = el('span', {class:'badge'}, it.source);
    h.appendChild(b);
    li.appendChild(h);
    if(it.summary) li.appendChild(el('div', {class:'meta'}, safeText(it.summary)));
    if(it.date) li.appendChild(el('div', {class:'meta'}, 'Date: '+it.date));
    container.appendChild(li);
  });
}

/* Export CSV */
function exportCSV(items){
  const rows = [['source','id','title','summary','url','date']];
  for(const it of items){
    rows.push([it.source||'', it.id||'', it.title||'', (it.summary||'').replace(/[\r\n]+/g,' '), it.url||'', it.date||'']);
  }
  const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'codemedicine_results.csv';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* Main */
document.addEventListener('DOMContentLoaded', ()=>{
  const form = q('#searchForm');
  const input = q('#query');
  const loading = q('#loading');
  const count = q('#count');
  const scount = q('#scount');
  const latencyEl = q('#latency');
  const warningsEl = q('#warnings');
  let lastResults = [];

  async function doSearch(ev){
    if(ev) ev.preventDefault();
    const qv = input.value.trim();
    if(!qv || qv.length < 2) return alert('Please enter a longer query (2+ chars).');
    loading.style.display = 'inline-block';
    warningsEl.style.display = 'none';
    warningsEl.textContent = '';
    const selectedSources = Array.from(document.querySelectorAll('.source:checked')).map(x=>x.value);
    const pageSize = Number(q('#pagesize').value) || 10;
    const sortMode = q('#sort').value || 'priority';
    const t0 = performance.now();
    try{
      const {items, warnings, latency} = await aggregate(qv, selectedSources, pageSize, sortMode);
      lastResults = items;
      renderResults(items);
      count.textContent = items.length;
      scount.textContent = Array.from(new Set(items.map(i=>i.source))).length;
      latencyEl.textContent = 'Latency: ' + latency + 'ms';
      if(warnings && warnings.length){
        warningsEl.style.display = 'inline-block';
        warningsEl.textContent = 'Warnings: ' + warnings.join('; ');
      } else { warningsEl.style.display='none'; }
    }catch(e){
      console.error(e);
      alert('Search failed: ' + (e.message || e));
    }finally{
      loading.style.display = 'none';
    }
  }

  form.addEventListener('submit', doSearch);
  q('#exportBtn').addEventListener('click', ()=> exportCSV(lastResults));

  // keyboard shortcut: Enter in input triggers search (form already handles)
});
</script>
</body>
</html>
